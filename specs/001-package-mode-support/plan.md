# Implementation Plan: Package Mode Support

**Branch**: `001-package-mode-support` | **Date**: 2026-01-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-package-mode-support/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

---

**ðŸ“‹ Constitution VI - Documentation Conciseness**: This plan MUST be readable in a single session. Focus on decisions and rationale, not exhaustive documentation. Avoid verbose explanations.

---

## Summary

Enable Flight Control Agent to run on package-based Linux systems (RHEL 9+, Ubuntu 22.04+) where the OS is managed via package managers (dnf/apt) rather than bootc images. Agent will automatically detect deployment mode and manage only Flight Control configurations/agent updates while ignoring OS-level package operations. Core technical approach: extend existing systeminfo detection in `internal/agent/device/systeminfo/` to identify package-mode vs image-mode environments based on bootc presence, then conditionally disable OS update management paths in agent workflow.

**Key Implementation Decision** (from research.md): Modification points limited to systeminfo detection (packagemode.go, manager.go) and agent update workflow (device.go beforeUpdate/afterUpdate). No changes required to bootstrap.go, spec manager, config, or data models - existing infrastructure supports package-mode via feature flags and JSONB extensibility.

## Technical Context

**Language/Version**: Go 1.24.0
**Primary Dependencies**: go-chi/chi v5 (HTTP), gRPC v1.73, GORM v1.25 (ORM), Ginkgo v2 (testing), OpenTelemetry v1.37 (observability)
**Storage**: PostgreSQL (primary via GORM), Redis v9 (caching), SQLite (tests)
**Testing**: Ginkgo v2 + Gomega, stretchr/testify, uber/mock, `make unit-test` / `make integration-test`
**Target Platform**: Linux (RHEL 9+, Ubuntu 22.04+, existing bootc-based distributions)
**Project Type**: Monorepo multi-service (agent + API + workers + periodic tasks)
**Performance Goals**: Environment detection <1ms, configuration updates <5s latency, zero conflicts with concurrent package manager operations
**Constraints**: No interference with dnf/apt, no bootc dependency in package-mode, backward compatible with image-mode devices
**Scale/Scope**: Support mixed fleets of thousands of devices (package-mode + image-mode)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with Flight Control Constitution v1.1.0:

- [x] **Code Quality & Simplicity**: Simple bootc presence check, no abstractions. Extends existing systeminfo collector pattern. No new dependencies.
- [x] **Edge Device Management**: Extends declarative management to package-mode devices. Device mode visible in status. No disruption to lifecycle.
- [x] **API Stability**: No breaking changes. Adds package-mode field to device status (backward compatible). Existing APIs unchanged.
- [x] **Test Coverage**: Unit tests for mode detection, integration tests for RHEL/Ubuntu. Mock file system checks. External dependency: bootc binary presence.
- [x] **Security**: No new auth boundaries. Mode detection validates file paths to prevent injection. No elevation of privileges.
- [x] **Documentation**: Spec concise (readable in one session). Plan focuses on decisions (bootc detection mechanism, conditional update logic).
- [x] **Observability**: Log package-mode detection at agent startup. Metrics for mode distribution across fleet. Status field visible in console UI.
- [x] **Performance & Scale**: <1ms detection overhead (single file check). Scales to heterogeneous fleets (no per-device performance impact).
- [x] **Quality Gates**: `make lint` required. `make unit-test` and `make integration-test` with RHEL runners (new infrastructure).

## Project Structure

### Documentation (this feature)

```text
specs/001-package-mode-support/
â”œâ”€â”€ plan.md              # This file
â”œâ”€â”€ research.md          # Phase 0: bootc detection mechanism, update path analysis
â”œâ”€â”€ data-model.md        # Phase 1: device status schema extension
â”œâ”€â”€ quickstart.md        # Phase 1: package-mode installation guide
â”œâ”€â”€ contracts/           # Phase 1: device status API updates
â”‚   â””â”€â”€ device-status.yaml
â””â”€â”€ tasks.md             # Phase 2: (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
flightctl/
â”œâ”€â”€ internal/agent/                    # Agent implementation (MODIFY)
â”‚   â”œâ”€â”€ device/
â”‚   â”‚   â”œâ”€â”€ systeminfo/                # ADD: package-mode detection
â”‚   â”‚   â”‚   â”œâ”€â”€ packagemode.go         # NEW: bootc presence check
â”‚   â”‚   â”‚   â””â”€â”€ packagemode_test.go    # NEW: detection tests
â”‚   â”‚   â”œâ”€â”€ device.go                  # MODIFY: beforeUpdate(), afterUpdate() skip OS ops in package-mode
â”‚   â”‚   â””â”€â”€ device_test.go             # NEW: unit tests for package-mode update logic
â”œâ”€â”€ internal/store/model/              # Data models (NO CODE CHANGE)
â”‚   â””â”€â”€ device.go                      # Status JSONB field auto-persists additionalProperties["packageMode"]
â”œâ”€â”€ internal/api/                      # API handlers (VERIFY - likely no change needed)
â”‚   â””â”€â”€ device.go                      # Status endpoint already returns full JSONB, includes packageMode
â”œâ”€â”€ test/integration/                  # Integration tests (NEW)
â”‚   â”œâ”€â”€ agent/
â”‚   â”‚   â”œâ”€â”€ packagemode_rhel_test.go   # NEW: RHEL package-mode tests
â”‚   â”‚   â””â”€â”€ packagemode_ubuntu_test.go # NEW: Ubuntu package-mode tests
â”‚   â””â”€â”€ fixtures/
â”‚       â”œâ”€â”€ rhel9-runner/              # NEW: RHEL test infrastructure
â”‚       â””â”€â”€ ubuntu22-runner/           # NEW: Ubuntu test infrastructure
â”œâ”€â”€ deploy/packaging/                  # Packaging (EXISTING, document usage)
â”‚   â”œâ”€â”€ rpm/                           # RPM spec files for RHEL
â”‚   â””â”€â”€ deb/                           # .deb package metadata (assumed available)
â””â”€â”€ docs/                              # Documentation (NEW)
    â””â”€â”€ user/installing/
        â”œâ”€â”€ installing-agent-rhel-package-mode.md    # NEW
        â””â”€â”€ installing-agent-ubuntu-package-mode.md  # NEW
```

**Structure Decision**: Monorepo modification. Extends existing agent systeminfo subsystem for mode detection. Package-mode status stored in existing DeviceSystemInfo.additionalProperties (JSONB, no schema change). Modifies agent device.go update workflow to skip OS operations when package-mode detected. No new services or binaries. Test infrastructure adds RHEL/Ubuntu runners to existing integration test framework.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No constitution violations. All gates passed.
